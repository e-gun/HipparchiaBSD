# open Terminal.app from the /Applications/Utilities folder
 
# from the command line: 
# install the brew package manager
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

# install python and postgresql
brew install python3
brew install postgresql

# postgresql will be available every time you restart
brew services start postgresql

# build the db framework
createdb hipparchiaDB
psql hipparchiaDB

#	[insert from ~/hipparchia_venv/HipparchiaBuilder/builder/sql/sample_generate_hipparchia_dbs.sql]
#	[set passwords for your two DB roles: please pick strong/hard gibberish passwords like "IQY%gOd$)&KV" ]
#	\password hippa_wr
#	\password hippa_rd
#	\q

# ready the installation files and directories
mkdir ~/hipparchia_venv
mkdir ~/hipparchia_venv/HipparchiaData ~/hipparchia_venv/HipparchiaServer ~/hipparchia_venv/HipparchiaSQLoader ~/hipparchia_venv/HipparchiaBuilder ~/hipparchia_venv/HipparchiaBSD
cd ~/hipparchia_venv/HipparchiaServer/ && git init && git pull https://github.com/e-gun/HipparchiaServer.git
cd ~/hipparchia_venv/HipparchiaBuilder/ && git init && git pull https://github.com/e-gun/HipparchiaBuilder.git
cd ~/hipparchia_venv/HipparchiaSQLoader/ && git init && git pull https://github.com/e-gun/HipparchiaSQLoader.git
cd ~/hipparchia_venv/HipparchiaBSD/ && git init && git pull https://github.com/e-gun/HipparchiaBSD.git
cp ~/hipparchia_venv/HipparchiaBSD/macOS_selfupdate.sh ~/hipparchia_venv/selfupdate.sh
chmod 700 ~/hipparchia_venv/selfupdate.sh
cp ~/hipparchia_venv/HipparchiaBSD/macos_launch_hipparchia_application.zip ~/hipparchia_venv
cd ~/hipparchia_venv
unzip ~/hipparchia_venv/macos_launch_hipparchia_application.zip
mv ~/hipparchia_venv/macos_launch_hipparchia_application.app ~/hipparchia_venv/launch_hipparchia.app

# prepare the python virtual environment
/usr/local/bin/pyvenv-3.5 ~/hipparchia_venv/
source ~/hipparchia_venv/bin/activate
~/hipparchia_venv/bin/pip3 install bs4 flask psycopg2

cp ~/hipparchia_venv/HipparchiaBuilder/sample_config.ini ~/hipparchia_venv/HipparchiaBuilder/config.ini
cp ~/hipparchia_venv/HipparchiaServer/sample_config.py ~/hipparchia_venv/HipparchiaServer/config.py

# edit your configuration files: the passwords for hippa_wr and hippa_rd are the key bit
# you don't have to use 'nano': TextEdit.app will work too
nano ~/hipparchia_venv/HipparchiaServer/config.py
nano ~/hipparchia_venv/HipparchiaBuilder/config.ini
cp ~/hipparchia_venv/HipparchiaBuilder/config.ini ~/hipparchia_venv/HipparchiaSQLoader/config.ini

# [install jquery and fonts in ~/hipparchia_venv/HipparchiaServer/server/static/]
# 	http://jqueryui.com/download/
#	http://jquery.com/download/
#	http://dejavu-fonts.org/wiki/Download

# [install data files in ~/hipparchia_venv/HipparchiaData]

cd ~/hipparchia_venv/HipparchiaBuilder && ~/hipparchia_venv/bin/python3 build_it_all.py

# when the build finishes you should be ready to run
# via the Terminal.app:
# ~/hipparchia_venv/bin/python3 ~/hipparchia_venv/HipparchiaServer/run.py
# via the supplied script: you can double-click it or tell the terminal the following

open ~/hipparchia_venv/launch_hipparchia.app

# you can move launch_hipparchia.app anywhere you want
# you can't move ~/hipparchia_venv unless you are willing to tinker with various settings

# after launching you should see something like:

#loading authors and works...
# * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)
# * Restarting with stat