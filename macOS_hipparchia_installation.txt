# this will do a complete macOS installation
# please see below: if you do not have access to the builder input files, you might have a serious problem
# it is an abbreviated and slightly modified version of a FreeBSD installation
# you can cut and paste most of the document safely into the terminal
# comments ('# ...') will be ignored
# but there are points where you are required to take action, so pasting the whole document at once would be bad

# open Terminal.app from the /Applications/Utilities folder
 
# from the command line: 

# test that you have the command lines tools available:
gcc

# success - you will see this message: 'clang: error: no input files'
# fail - macOS will attempt to download and install the tools you need to go forward
# if *that* does not work: you manually download XCode from the App Store (for free), install, and try again

# install the brew package manager
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

# install python and postgresql
brew install python3
brew install postgresql

# postgresql will be available every time you restart (you almost certainly want this if you plan to use hipparchia regularly)
brew services start postgresql

# you may have to tell your firewall to let postgresql accept connections

# ready the installation files and directories
# cut-and-paste this block with abandon
mkdir ~/hipparchia_venv
mkdir ~/hipparchia_venv/HipparchiaData ~/hipparchia_venv/HipparchiaServer ~/hipparchia_venv/HipparchiaSQLoader ~/hipparchia_venv/HipparchiaBuilder ~/hipparchia_venv/HipparchiaBSD
cd ~/hipparchia_venv/HipparchiaServer/ && git init && git pull https://github.com/e-gun/HipparchiaServer.git
cd ~/hipparchia_venv/HipparchiaBuilder/ && git init && git pull https://github.com/e-gun/HipparchiaBuilder.git
cd ~/hipparchia_venv/HipparchiaSQLoader/ && git init && git pull https://github.com/e-gun/HipparchiaSQLoader.git
cd ~/hipparchia_venv/HipparchiaBSD/ && git init && git pull https://github.com/e-gun/HipparchiaBSD.git
cp ~/hipparchia_venv/HipparchiaBSD/macOS_selfupdate.sh ~/hipparchia_venv/selfupdate.sh
chmod 700 ~/hipparchia_venv/selfupdate.sh
cp -rp ~/hipparchia_venv/HipparchiaBSD/macos_launch_hipparchia_application.app ~/hipparchia_venv/launch_hipparchia.app

# build the db framework
createdb -E UTF8 hipparchiaDB
psql -d hipparchiaDB -a -f ~/hipparchia_venv/HipparchiaBuilder/builder/sql/sample_generate_hipparchia_dbs.sql

# you are about to enter the SQL shell: time to sit up and take notice of these comments
psql hipparchiaDB

# this next bit can't be done with cut-and-paste: you have to read and follow the instructions
#
#	[set two different passwords for your two different DB roles: please pick strong/hard gibberish passwords like "IQY%gOd$)&KV" and "~=#ThR05D3" ]
#	\password hippa_wr
#	\password hippa_rd
#	\q

# prepare the python virtual environment
/usr/local/bin/python3.6 -m venv ~/hipparchia_venv/
source ~/hipparchia_venv/bin/activate
~/hipparchia_venv/bin/pip3 install bs4 flask psycopg2

cp ~/hipparchia_venv/HipparchiaBuilder/sample_config.ini ~/hipparchia_venv/HipparchiaBuilder/config.ini
cp ~/hipparchia_venv/HipparchiaServer/sample_config.py ~/hipparchia_venv/HipparchiaServer/config.py

# this next bit can't be done with cut-and-paste: you have to read and follow the instructions
# edit your configuration files: the passwords for hippa_wr and hippa_rd are the key bit
# they must match what you entered after you did '\password hippa_wr' and '\password hippa_rd' above
open -a /Applications/TextEdit.app ~/hipparchia_venv/HipparchiaServer/config.py
open -a /Applications/TextEdit.app ~/hipparchia_venv/HipparchiaBuilder/config.ini
open -a /Applications/TextEdit.app ~/hipparchia_venv/HipparchiaSQLoader/config.ini
cp ~/hipparchia_venv/HipparchiaBuilder/config.ini ~/hipparchia_venv/HipparchiaSQLoader/config.ini

# [install jquery and fonts in ~/hipparchia_venv/HipparchiaServer/server/static/]
# [download from here]
# 	http://jqueryui.com/download/
#	http://jquery.com/download/
#	http://dejavu-fonts.org/wiki/Download
# [to see the folder where the downloads need to go]
open ~/hipparchia_venv/HipparchiaServer/server/static/

# here comes the SHOWSTOPPER moment if you are going to be a HipparchiaBuilder
# if you do not have access to the data, then you can't build
# and this data is not available on github and unlikely ever to be available on github
# You need access to the TLG_E and PHI00005 and PHI7 disks. Get your hands on them.
# I do not know if other versions will build. They probably will.  

# OPTION ONE: BE BUILDER
# if you have the builder data, then...
cd ~/hipparchia_venv/HipparchiaBuilder && ~/hipparchia_venv/bin/python3 build_it_all.py

# build times vary, but 10-40m per corpus should be possible on most machines. 
# 5-25m is achievable if you are a speed freak who knows how to optimize for your rig

# OPTION TWO: BE A RELOADER
# if you have access to a HipparchiaSQLoader dump, then...
# cd ~/hipparchia_venv/HipparchiaSQLoader/ && ../bin/python ./reloadhipparchiaDBs.py 

# CONGRATULATIONS: Hipparchia's data has been installed
# you are now ready to run HipparchiaServer 

# OPTION ONE: via the Terminal.app:
# ~/hipparchia_venv/bin/python3 ~/hipparchia_venv/HipparchiaServer/run.py

# OPTION TWO: via the supplied applescript script: you can double-click it or tell the terminal the following
open ~/hipparchia_venv/launch_hipparchia.app

# you can move launch_hipparchia.app anywhere you want
# you can't move ~/hipparchia_venv unless you are willing to tinker with various settings

# after launching you should see something like:

#loading all authors...
#	 3455 authors loaded
#loading all works...
#	 235461 works loaded
#building specialized sublists
# * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)
# * Restarting with stat

# if you love the command line then:
open http://localhost:5000

# otherwise you can open any web browser and surf to Hipparchia's front page:
# 	http://localhost:5000

# WARNING
# HipparchiaServer is a server; and you are now serving on port 5000.
#
# You are serving to ANYONE ANYWHERE in the world unless you are either
# behind a firewall or are going to manually block access to this port to outsiders 
# I cannot recommend strongly enough that you have some sort of protection for 
# this port on your machine.
#
# There are plenty of security checks inside HipparchiaServer, but you just chose to 
# skip a critical piece of the security puzzle. So I can't feel that bad if I missed something 
# in my code since you did not do your part either.
#
# If you have no firewall and picked a terrible password for hippa_wr, then you
# must be the sort of person who loves international adventure and fun games like
# running with scissors. They play the coolest kind of roulette in Russia, I am told.


# KEEPING UP TO DATE:
# 	from the terminal run
# 	~/hipparchia_venv/selfupdate.sh
# 
# WARNING
# HipparchiaServer and HipparchiaBuilder are both in active development 
# It is possible that the latest version of HipparchiaServer requires DBs built with 
# a version of HipparchiaBuilder that did not build the DBs you have installed
#
# in short an update can BREAK your installation unless you have access to the build data or freshly built DBs
# HipparchiaServer will tell you if your data is not a match, but only after you have loaded it: i.e. after you have done something you might regret
# you can use github to pull any version of Hipparchia ever, so reversion is definitely possible, just not very fun/easy
# the data mismatch warning should give you some idea of where to pick as a reversion date in the code history 
#
# the data template should stabilize 'eventually': at the moment it seldom changes; I hope to turn that into 'never'


